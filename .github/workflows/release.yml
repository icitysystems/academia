# =============================================================================
# Release Management Workflow
# =============================================================================
# Handles version bumping, changelog generation, and release creation

name: Release Management

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: "Pre-release identifier (e.g., beta, rc)"
        required: false
        default: ""

env:
  NODE_VERSION: "20"

jobs:
  # ===========================================================================
  # Create Release
  # ===========================================================================

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
      tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(cat backend/package.json | jq -r '.version')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: version
        run: |
          CURRENT="${{ steps.current.outputs.current_version }}"
          TYPE="${{ github.event.inputs.version_type }}"
          PRERELEASE="${{ github.event.inputs.prerelease }}"

          # Parse current version
          IFS='.' read -ra VERSION_PARTS <<< "${CURRENT%-*}"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          # Calculate new version
          case $TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"

          if [ -n "$PRERELEASE" ]; then
            NEW_VERSION="${NEW_VERSION}-${PRERELEASE}"
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update package.json versions
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          # Update backend
          cd backend
          npm version $NEW_VERSION --no-git-tag-version
          cd ..

          # Update frontend
          cd frontend
          npm version $NEW_VERSION --no-git-tag-version
          cd ..

          # Update mobile
          cd mobile
          npm version $NEW_VERSION --no-git-tag-version
          cd ..

      - name: Generate changelog
        id: changelog
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          echo "## What's Changed in v${NEW_VERSION}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "### Commits since ${PREVIOUS_TAG}" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
          else
            echo "### Initial Release" >> RELEASE_NOTES.md
            git log --pretty=format:"- %s (%h)" -20 >> RELEASE_NOTES.md
          fi

          echo "" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### Deployment" >> RELEASE_NOTES.md
          echo "- **Database:** academia (RDS PostgreSQL db.t3.micro - icitysystems)" >> RELEASE_NOTES.md
          echo "- **Backend:** AWS Lambda + API Gateway" >> RELEASE_NOTES.md
          echo "- **Frontend:** S3 + CloudFront" >> RELEASE_NOTES.md

          cat RELEASE_NOTES.md

      - name: Create release branch
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          git checkout -b release/v${NEW_VERSION}
          git add .
          git commit -m "chore: bump version to ${NEW_VERSION}"
          git push origin release/v${NEW_VERSION}

      - name: Create Pull Request to main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: release/v${{ steps.version.outputs.new_version }}
          base: main
          title: "Release v${{ steps.version.outputs.new_version }}"
          body-path: RELEASE_NOTES.md
          labels: release

      - name: Output summary
        run: |
          echo "## ðŸš€ Release Prepared" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ github.event.inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** release/v${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review and merge the PR to main" >> $GITHUB_STEP_SUMMARY
          echo "2. After merge, create tag: \`git tag -a v${{ steps.version.outputs.new_version }} -m 'Release v${{ steps.version.outputs.new_version }}'\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Push tag: \`git push origin v${{ steps.version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Approve production deployment in GitHub Actions" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Create GitHub Release (after tag is pushed)
  # ===========================================================================

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Release Notes
        id: notes
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${TAG}^ 2>/dev/null || echo "")

          echo "## What's Changed" > notes.md
          echo "" >> notes.md

          if [ -n "$PREVIOUS_TAG" ]; then
            git log ${PREVIOUS_TAG}..${TAG} --pretty=format:"- %s (%h)" >> notes.md
          else
            git log --pretty=format:"- %s (%h)" -20 >> notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: notes.md
          generate_release_notes: true
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-rc') || contains(github.ref, '-alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
