# =============================================================================
# Scheduled Maintenance Jobs
# =============================================================================
# Runs periodic tasks for security, cleanup, and monitoring

name: Scheduled Maintenance

on:
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: "0 2 * * *"
    # Run dependency updates weekly on Monday at 3 AM UTC
    - cron: "0 3 * * 1"
  workflow_dispatch:
    inputs:
      task:
        description: "Task to run"
        required: true
        type: choice
        options:
          - security-scan
          - dependency-check
          - cleanup-artifacts
          - database-backup-check

env:
  NODE_VERSION: "20"
  AWS_REGION: us-east-1

jobs:
  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *' || github.event.inputs.task == 'security-scan'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "CRITICAL,HIGH,MEDIUM"
          format: "sarif"
          output: "trivy-results.sarif"
      
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-results.sarif"
      
      - name: npm audit - Backend
        working-directory: backend
        run: |
          npm ci
          npm audit --json > audit-backend.json || true
          if [ -s audit-backend.json ]; then
            echo "## Backend Security Audit" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat audit-backend.json | jq '.metadata' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: npm audit - Frontend
        working-directory: frontend
        run: |
          npm ci
          npm audit --json > audit-frontend.json || true
          if [ -s audit-frontend.json ]; then
            echo "## Frontend Security Audit" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat audit-frontend.json | jq '.metadata' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Dependency Updates Check
  # ===========================================================================
  
  dependency-check:
    name: Dependency Updates
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 3 * * 1' || github.event.inputs.task == 'dependency-check'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Check Backend Dependencies
        working-directory: backend
        run: |
          npm ci
          echo "## Backend Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Check Frontend Dependencies
        working-directory: frontend
        run: |
          npm ci
          echo "## Frontend Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Check Infrastructure Dependencies
        working-directory: infrastructure/cdk
        run: |
          npm ci
          echo "## Infrastructure Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Artifact Cleanup
  # ===========================================================================
  
  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'cleanup-artifacts'
    
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10

  # ===========================================================================
  # Database Backup Verification
  # ===========================================================================
  
  database-backup-check:
    name: Database Backup Check
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'database-backup-check'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Check RDS Backups
        run: |
          echo "## RDS Backup Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get latest automated backup
          LATEST_BACKUP=$(aws rds describe-db-snapshots \
            --db-instance-identifier icitysystems \
            --snapshot-type automated \
            --query 'DBSnapshots | sort_by(@, &SnapshotCreateTime) | [-1]' \
            --output json 2>/dev/null || echo "{}")
          
          if [ "$LATEST_BACKUP" != "{}" ]; then
            BACKUP_TIME=$(echo $LATEST_BACKUP | jq -r '.SnapshotCreateTime')
            BACKUP_STATUS=$(echo $LATEST_BACKUP | jq -r '.Status')
            echo "**Latest Backup:** $BACKUP_TIME" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** $BACKUP_STATUS" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No automated backups found" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Summary Report
  # ===========================================================================
  
  maintenance-summary:
    name: Maintenance Summary
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-check]
    if: always() && (github.event.schedule == '0 2 * * *' || github.event.schedule == '0 3 * * 1')
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ”§ Scheduled Maintenance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ…' || needs.security-scan.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Check | ${{ needs.dependency-check.result == 'success' && 'âœ…' || needs.dependency-check.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
