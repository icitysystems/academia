{
 "Description": "Academia SES Email Service - academia@icitysystems.org",
 "Resources": {
  "EmailBucket843A740F": {
   "Type": "AWS::S3::Bucket",
   "Properties": {
    "BucketEncryption": {
     "ServerSideEncryptionConfiguration": [
      {
       "ServerSideEncryptionByDefault": {
        "SSEAlgorithm": "AES256"
       }
      }
     ]
    },
    "BucketName": "academia-emails-771643347382",
    "LifecycleConfiguration": {
     "Rules": [
      {
       "ExpirationInDays": 90,
       "Status": "Enabled"
      }
     ]
    },
    "PublicAccessBlockConfiguration": {
     "BlockPublicAcls": true,
     "BlockPublicPolicy": true,
     "IgnorePublicAcls": true,
     "RestrictPublicBuckets": true
    }
   },
   "UpdateReplacePolicy": "Retain",
   "DeletionPolicy": "Retain",
   "Metadata": {
    "aws:cdk:path": "AcademiaSes/EmailBucket/Resource"
   }
  },
  "EmailBucketPolicyBBC68546": {
   "Type": "AWS::S3::BucketPolicy",
   "Properties": {
    "Bucket": {
     "Ref": "EmailBucket843A740F"
    },
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "s3:PutObject",
       "Condition": {
        "StringEquals": {
         "aws:SourceAccount": "771643347382"
        }
       },
       "Effect": "Allow",
       "Principal": {
        "Service": "ses.amazonaws.com"
       },
       "Resource": {
        "Fn::Join": [
         "",
         [
          {
           "Fn::GetAtt": [
            "EmailBucket843A740F",
            "Arn"
           ]
          },
          "/*"
         ]
        ]
       }
      },
      {
       "Action": "s3:PutObject",
       "Condition": {
        "StringEquals": {
         "aws:SourceAccount": {
          "Ref": "AWS::AccountId"
         }
        }
       },
       "Effect": "Allow",
       "Principal": {
        "Service": "ses.amazonaws.com"
       },
       "Resource": {
        "Fn::Join": [
         "",
         [
          {
           "Fn::GetAtt": [
            "EmailBucket843A740F",
            "Arn"
           ]
          },
          "/*"
         ]
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "AcademiaSes/EmailBucket/Policy/Resource"
   }
  },
  "EmailForwarderServiceRole93812A13": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "AcademiaSes/EmailForwarder/ServiceRole/Resource"
   }
  },
  "EmailForwarderServiceRoleDefaultPolicyD3A7F3A7": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "s3:GetObject*",
        "s3:GetBucket*",
        "s3:List*"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::GetAtt": [
          "EmailBucket843A740F",
          "Arn"
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::GetAtt": [
             "EmailBucket843A740F",
             "Arn"
            ]
           },
           "/*"
          ]
         ]
        }
       ]
      },
      {
       "Action": [
        "ses:SendRawEmail",
        "ses:SendEmail"
       ],
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "EmailForwarderServiceRoleDefaultPolicyD3A7F3A7",
    "Roles": [
     {
      "Ref": "EmailForwarderServiceRole93812A13"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "AcademiaSes/EmailForwarder/ServiceRole/DefaultPolicy/Resource"
   }
  },
  "EmailForwarder4C52F0F4": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "ZipFile": "\nconst { SESClient, SendRawEmailCommand } = require('@aws-sdk/client-ses');\nconst { S3Client, GetObjectCommand } = require('@aws-sdk/client-s3');\n\nconst ses = new SESClient({});\nconst s3 = new S3Client({});\n\nexports.handler = async (event) => {\n  console.log('Email forwarder triggered:', JSON.stringify(event, null, 2));\n\n  for (const record of event.Records) {\n    const sesNotification = record.ses;\n    const messageId = sesNotification.mail.messageId;\n    const bucket = process.env.EMAIL_BUCKET;\n\n    try {\n      // Get the email from S3\n      const s3Response = await s3.send(new GetObjectCommand({\n        Bucket: bucket,\n        Key: messageId,\n      }));\n\n      // Read the email content\n      const chunks = [];\n      for await (const chunk of s3Response.Body) {\n        chunks.push(chunk);\n      }\n      let emailContent = Buffer.concat(chunks).toString('utf-8');\n\n      // Modify headers for forwarding\n      const originalFrom = sesNotification.mail.commonHeaders.from[0];\n      const originalSubject = sesNotification.mail.commonHeaders.subject || '(no subject)';\n\n      // Replace the From header to comply with SES policies\n      // Keep original sender info in the subject\n      emailContent = emailContent.replace(\n        /^From: .*/m,\n        `From: \"Academia Forwarded\" <${process.env.FROM_EMAIL}>`\n      );\n\n      // Add Reply-To header with original sender\n      if (!emailContent.match(/^Reply-To:/m)) {\n        emailContent = emailContent.replace(\n          /^From: /m,\n          `Reply-To: ${originalFrom}\\nFrom: `\n        );\n      }\n\n      // Modify subject to indicate forwarding\n      emailContent = emailContent.replace(\n        /^Subject: .*/m,\n        `Subject: [Fwd: Academia] ${originalSubject}`\n      );\n\n      // Replace the To header\n      emailContent = emailContent.replace(\n        /^To: .*/m,\n        `To: ${process.env.FORWARD_TO}`\n      );\n\n      // Send the forwarded email\n      await ses.send(new SendRawEmailCommand({\n        RawMessage: { Data: Buffer.from(emailContent) },\n        Destinations: [process.env.FORWARD_TO],\n        Source: process.env.FROM_EMAIL,\n      }));\n\n      console.log(`Email ${messageId} forwarded successfully to ${process.env.FORWARD_TO}`);\n    } catch (error) {\n      console.error(`Failed to forward email ${messageId}:`, error);\n      throw error;\n    }\n  }\n\n  return { status: 'success' };\n};\n\t\t\t"
    },
    "Environment": {
     "Variables": {
      "FORWARD_TO": "icitysystems@gmail.com",
      "FROM_EMAIL": "academia@icitysystems.org",
      "EMAIL_BUCKET": {
       "Ref": "EmailBucket843A740F"
      }
     }
    },
    "FunctionName": "academia-email-forwarder",
    "Handler": "index.handler",
    "MemorySize": 256,
    "Role": {
     "Fn::GetAtt": [
      "EmailForwarderServiceRole93812A13",
      "Arn"
     ]
    },
    "Runtime": "nodejs20.x",
    "Timeout": 30
   },
   "DependsOn": [
    "EmailForwarderServiceRoleDefaultPolicyD3A7F3A7",
    "EmailForwarderServiceRole93812A13"
   ],
   "Metadata": {
    "aws:cdk:path": "AcademiaSes/EmailForwarder/Resource"
   }
  },
  "EmailForwarderSESInvoke961CBAEB": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "EmailForwarder4C52F0F4",
      "Arn"
     ]
    },
    "Principal": "ses.amazonaws.com",
    "SourceAccount": "771643347382"
   },
   "Metadata": {
    "aws:cdk:path": "AcademiaSes/EmailForwarder/SESInvoke"
   }
  },
  "EmailForwarderAllowSes8703373E": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "EmailForwarder4C52F0F4",
      "Arn"
     ]
    },
    "Principal": "ses.amazonaws.com",
    "SourceAccount": {
     "Ref": "AWS::AccountId"
    }
   },
   "Metadata": {
    "aws:cdk:path": "AcademiaSes/EmailForwarder/AllowSes"
   }
  },
  "EmailRuleSetD2B2D9EA": {
   "Type": "AWS::SES::ReceiptRuleSet",
   "Properties": {
    "RuleSetName": "academia-email-rules"
   },
   "Metadata": {
    "aws:cdk:path": "AcademiaSes/EmailRuleSet/Resource"
   }
  },
  "AcademiaEmailRule3EFCA513": {
   "Type": "AWS::SES::ReceiptRule",
   "Properties": {
    "Rule": {
     "Actions": [
      {
       "S3Action": {
        "BucketName": {
         "Ref": "EmailBucket843A740F"
        }
       }
      },
      {
       "LambdaAction": {
        "FunctionArn": {
         "Fn::GetAtt": [
          "EmailForwarder4C52F0F4",
          "Arn"
         ]
        },
        "InvocationType": "Event"
       }
      }
     ],
     "Enabled": true,
     "Name": "academia-forward-rule",
     "Recipients": [
      "academia@icitysystems.org"
     ],
     "ScanEnabled": true
    },
    "RuleSetName": {
     "Ref": "EmailRuleSetD2B2D9EA"
    }
   },
   "DependsOn": [
    "EmailBucketPolicyBBC68546",
    "EmailForwarderAllowSes8703373E"
   ],
   "Metadata": {
    "aws:cdk:path": "AcademiaSes/AcademiaEmailRule/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/12OTQrCMBCFz9J9OtYUPICCW0s8gMR0hGnTpHQSRULuLhpFcfW9n+ExEmTbQlPpG9emH2tLZ0jHoM0o9I1PiVtI22hGDGJ3cW9V0HlL5v6Ni8/C6unca0j76Ewg754Xv7rDZSJm8i4L0hMk5S0+ixe/q589Roak0CDNQUWLx/LLX/Jj/9qchUL2cTGv5hDDHEMWzvcIA6+uUsJ6A001MFG9RBdoQlCFD8SEQqkfAQAA"
   },
   "Metadata": {
    "aws:cdk:path": "AcademiaSes/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "EmailIdentityArn": {
   "Description": "SES Email Identity ARN",
   "Value": "arn:aws:ses:us-east-1:771643347382:identity/icitysystems.org"
  },
  "EmailBucketName": {
   "Description": "S3 bucket for storing received emails",
   "Value": {
    "Ref": "EmailBucket843A740F"
   }
  },
  "ForwarderFunctionArn": {
   "Description": "Email forwarder Lambda function ARN",
   "Value": {
    "Fn::GetAtt": [
     "EmailForwarder4C52F0F4",
     "Arn"
    ]
   }
  },
  "DnsSetupInstructions": {
   "Description": "DNS setup instructions for SES",
   "Value": "\nDNS Records Required for SES:\n1. Domain verification: Check SES console for DKIM CNAME records\n2. MX Record: Add MX record for inbound-smtp.us-east-1.amazonaws.com with priority 10\n3. SPF Record: Add TXT record \"v=spf1 include:amazonses.com ~all\"\n4. MAIL FROM: Add MX record for mail.icitysystems.org pointing to feedback-smtp.us-east-1.amazonses.com\n\nAfter DNS verification:\n- Activate the receipt rule set 'academia-email-rules' in SES console\n- Request production access if still in sandbox mode\n\t\t\t"
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}